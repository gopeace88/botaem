# 컴포넌트 배치 다이어그램

## 시스템 구성

```
┌──────────────────────────────────────────────────────────────────────┐
│                           CLOUD (Supabase)                           │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────────────┐ │
│  │  PostgreSQL    │  │  Supabase Auth │  │  Supabase Storage      │ │
│  ├────────────────┤  ├────────────────┤  ├────────────────────────┤ │
│  │ - pages        │  │ - User 관리    │  │ - screenshots/         │ │
│  │ - elements     │  │ - API Keys     │  │                        │ │
│  │ - playbooks    │  │ - RLS 정책     │  │                        │ │
│  │ - credentials  │  │                │  │                        │ │
│  │ - exec_logs    │  │                │  │                        │ │
│  └────────────────┘  └────────────────┘  └────────────────────────┘ │
│           │                   │                    │                │
│           └───────────────────┼────────────────────┘                │
│                               │                                     │
│                        Supabase REST API                            │
│                               │                                     │
└───────────────────────────────┼─────────────────────────────────────┘
                                │
                                │ HTTPS
                                │
┌───────────────────────────────┼─────────────────────────────────────┐
│                    LOCAL (Electron App)                              │
├───────────────────────────────┼─────────────────────────────────────┤
│                               │                                     │
│  ┌────────────────────────────┴────────────────────────────────┐   │
│  │                    Main Process (Node.js)                    │   │
│  ├──────────────────────────────────────────────────────────────┤   │
│  │                                                              │   │
│  │  ┌─────────────────┐  ┌─────────────────┐                   │   │
│  │  │ Supabase Client │  │ Playbook Runner │                   │   │
│  │  │ - 플레이북 동기화 │  │ - steps 실행    │                   │   │
│  │  │ - 인증 정보 관리 │  │ - 변수 처리     │                   │   │
│  │  └─────────────────┘  └────────┬────────┘                   │   │
│  │                                │                             │   │
│  │  ┌─────────────────┐  ┌───────┴─────────┐                   │   │
│  │  │ Claude Service  │  │ Playwright      │                   │   │
│  │  │ - AI 챗         │  │ - 브라우저 제어  │                   │   │
│  │  │ - 플레이북 추천  │  │ - 요소 찾기     │                   │   │
│  │  └─────────────────┘  └─────────────────┘                   │   │
│  │                                                              │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                               │                                     │
│                               │ IPC                                 │
│                               │                                     │
│  ┌────────────────────────────┴────────────────────────────────┐   │
│  │                  Renderer Process (React)                    │   │
│  ├──────────────────────────────────────────────────────────────┤   │
│  │                                                              │   │
│  │  ┌─────────────────┐  ┌─────────────────┐                   │   │
│  │  │ Chat UI         │  │ Playbook List   │                   │   │
│  │  │ - 사용자 입력    │  │ - 플레이북 목록  │                   │   │
│  │  │ - AI 응답 표시   │  │ - 실행 버튼     │                   │   │
│  │  └─────────────────┘  └─────────────────┘                   │   │
│  │                                                              │   │
│  │  ┌─────────────────┐  ┌─────────────────┐                   │   │
│  │  │ Recording Mode  │  │ Progress View   │                   │   │
│  │  │ - 액션 기록     │  │ - 실행 상태     │                   │   │
│  │  │ - 셀렉터 편집   │  │ - 에러 표시     │                   │   │
│  │  └─────────────────┘  └─────────────────┘                   │   │
│  │                                                              │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                     Local Storage                             │   │
│  │  ~/.config/botame-guide-app/                                  │   │
│  │  ├── browser-data/     # Playwright 세션                      │   │
│  │  ├── playbooks/        # YAML 캐시                            │   │
│  │  └── settings.json     # 앱 설정                              │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                │ HTTP (Playwright)
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      TARGET WEBSITE (losims.go.kr)                   │
└─────────────────────────────────────────────────────────────────────┘
```

## 핵심 데이터 흐름

### 1. 플레이북 실행

```
사용자 ──"자동 로그인"──> Chat UI
                           │
                           ▼
                    Claude Service
                    (Intent 분석)
                           │
                           ▼
                    Playbook Runner
                           │
        ┌──────────────────┼──────────────────┐
        ▼                  ▼                  ▼
   Step 1: navigate   Step 2: click     Step 3: type
        │                  │                  │
        └──────────────────┼──────────────────┘
                           ▼
                      Playwright
                           │
                           ▼
                    Target Website
```

### 2. Recording Mode (플레이북 생성)

```
사용자 ──"녹화 시작"──> Recording UI
                           │
                           ▼
                    Playwright 감시
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
사용자 클릭         사용자 입력         페이지 이동
        │                  │                  │
        ▼                  ▼                  ▼
    액션 기록          액션 기록         페이지 감지
        │                  │                  │
        └──────────────────┼──────────────────┘
                           ▼
                    Steps 배열 생성
                           │
                           ▼
                    Supabase 저장
```

### 3. 오프라인 동기화

```
┌─────────────┐                    ┌─────────────┐
│  Supabase   │                    │  Local YAML │
│  (원본)     │                    │  (캐시)     │
└──────┬──────┘                    └──────┬──────┘
       │                                  │
       │  ◄───── 온라인 시 동기화 ─────►  │
       │                                  │
       │                                  │
       │  오프라인 시                      │
       │  ─────────────────────────────►  │
       │         Local에서 실행            │
       │                                  │
```

## 기술 스택

| 레이어 | 컴포넌트 | 기술 |
|--------|----------|------|
| **Cloud** | Database | Supabase (PostgreSQL) |
| | Auth | Supabase Auth |
| | Storage | Supabase Storage |
| **Local** | App | Electron |
| | Frontend | React + TypeScript |
| | Browser | Playwright |
| | AI | Claude API |
| | Local DB | YAML 파일 |

## 보안

### Credentials 암호화

```
사용자 입력 (비밀번호)
       │
       ▼
클라이언트 암호화 (AES-256-GCM)
       │
       ▼
Supabase 저장 (encrypted_data)
       │
       ▼
실행 시 클라이언트에서 복호화
```

- 서버에서는 암호화된 데이터만 저장
- 복호화 키는 사용자 기기에만 존재
- RLS로 본인 데이터만 접근 가능

## 구현 우선순위

### Phase 1 (현재)
- [x] 로컬 YAML 플레이북 실행
- [x] Chat UI + Claude 연동
- [ ] Supabase 연동

### Phase 2
- [ ] 플레이북 DB 동기화
- [ ] Recording Mode 기본 기능
- [ ] 다중 셀렉터 지원

### Phase 3
- [ ] 오프라인 지원
- [ ] 플레이북 공유
- [ ] 실행 통계 대시보드
